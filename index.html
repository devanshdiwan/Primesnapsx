<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>User Links</title>
<style>
  :root{--maxw:420px; --skel-bg: #2a2b2e;}
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif;
    background:#0e0f12;
    color:#fff;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px 14px;
  }
  .wrap{width:100%;max-width:var(--maxw);text-align:center}
  .avatar{width:120px;height:120px;border-radius:50%;overflow:hidden;margin:0 auto 10px;border:2px solid #ffffff22}
  .avatar img{width:100%;height:100%;object-fit:cover; background: var(--skel-bg);}
  .name{font-weight:700;font-size:1.5rem; min-height: 29px;} /* min-height to prevent layout shift */
  .bio{color:#cfd3da;margin-bottom:18px; min-height: 20px;}
  .links{display:flex;flex-direction:column;gap:12px;margin-top:10px}
  .link{
    display:flex;align-items:center;gap:10px;text-decoration:none;background:#eee;color:#111;
    padding:14px;border-radius:14px;font-weight:700;border:1px solid #00000010
  }
  .link:active{transform:translateY(1px)}
  .icon{
    width:32px;height:32px;border-radius:50%;overflow:hidden;flex-shrink:0;
    background:#fff;display:grid;place-items:center;border:1px solid #00000014;
  }
  .icon img{width:100%;height:100%;object-fit:cover}

  /* --- Skeleton Loader Styles --- */
  .skeleton {
    opacity: .7;
    animation: skeleton-loading 1s linear infinite alternate;
  }
  .skeleton-avatar { width: 120px; height: 120px; border-radius: 50%; }
  .skeleton-text { width: 60%; height: 24px; margin: 5px auto; border-radius: 8px; }
  .skeleton-bio { width: 80%; height: 20px; margin: 0 auto 18px; border-radius: 8px; }
  .skeleton-link { width: 100%; height: 62px; border-radius: 14px; }
  @keyframes skeleton-loading {
    0% { background-color: var(--skel-bg); }
    100% { background-color: #3f4044; }
  }

</style>
</head>
<body>
<main class="wrap">
  <!-- Structure with Skeleton Loader -->
  <div id="avatar-container" class="avatar">
    <div id="avatar-skeleton" class="skeleton skeleton-avatar"></div>
    <img id="avatar" alt="" style="display:none;">
  </div>
  <div id="name-container" class="name">
    <div id="name-skeleton" class="skeleton skeleton-text"></div>
    <span id="name" style="display:none;"></span>
  </div>
  <div id="bio-container" class="bio">
    <div id="bio-skeleton" class="skeleton skeleton-bio"></div>
    <span id="bio" style="display:none;"></span>
  </div>
  <div id="links" class="links" aria-label="Links">
    <!-- Skeleton links -->
    <div class="skeleton skeleton-link"></div>
    <div class="skeleton skeleton-link"></div>
    <div class="skeleton skeleton-link"></div>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB6S12pE6M9LbWJC0-wX9dJAboGZ2cYmy0",
    authDomain: "skillforgex-6aaa1.firebaseapp.com",
    databaseURL: "https://skillforgex-6aaa1-default-rtdb.firebaseio.com",
    projectId: "skillforgex-6aaa1",
    storageBucket: "skillforgex-6aaa1.firebasestorage.app",
    messagingSenderId: "817642126335",
    appId: "1:817642126335:web:388f34f7d2e1a0432a85ca",
    measurementId: "G-CDK62W0PW1"
  };

  // --- Helper Functions ---
  const isAbsolute = (u) => /^(https?:|mailto:|tel:)/i.test(u);
  const normalize = (u) => {
    if(!u) return "#";
    u = u.trim();
    return isAbsolute(u) ? u : "https://" + u.replace(/^\/+/, "");
  };

  // --- Rendering Function ---
  function renderPage(data) {
    const profile = data.profile || {};
    const links = Array.isArray(data.links) ? data.links : [];

    // Hide skeletons and show content
    document.getElementById("avatar-skeleton").style.display = 'none';
    const avatarImg = document.getElementById("avatar");
    avatarImg.src = profile.avatar || "";
    avatarImg.style.display = 'block';

    document.getElementById("name-skeleton").style.display = 'none';
    const nameEl = document.getElementById("name");
    nameEl.textContent = profile.name || "No name";
    nameEl.style.display = 'block';

    document.getElementById("bio-skeleton").style.display = 'none';
    const bioEl = document.getElementById("bio");
    bioEl.textContent = profile.bio || "";
    bioEl.style.display = 'block';

    const list = document.getElementById("links");
    list.innerHTML = ""; // Clear skeleton links

    links.forEach(item => {
      const a = document.createElement("a");
      a.className = "link";
      a.href = normalize(item.url);
      a.target = "_blank";
      a.rel = "noopener noreferrer";

      const ic = document.createElement("div");
      ic.className = "icon";
      if (item.icon && item.icon.startsWith("data:image")) {
        const img = document.createElement("img");
        img.src = item.icon;
        img.alt = "";
        ic.appendChild(img);
      } else {
        ic.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24"><path fill="#888" d="M10.59,13.41C11,13.8 11,14.44 10.59,14.83C10.2,15.22 9.56,15.22 9.17,14.83C7.22,12.88 7.22,9.71 9.17,7.76V7.76L12,10.59L14.83,7.76C16.78,9.71 16.78,12.88 14.83,14.83C14.44,15.22 13.8,15.22 13.41,14.83C13,14.44 13,13.8 13.41,13.41L14.12,12.7L12,10.59L9.88,12.7L10.59,13.41M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"></path></svg>';
      }

      const title = document.createElement("span");
      title.textContent = item.title || "Untitled";

      a.appendChild(ic);
      a.appendChild(title);
      list.appendChild(a);
    });
  }

  // --- Main Function ---
  async function main() {
    // 1. Try to load data from cache first for instant load
    const cachedData = localStorage.getItem('userData');
    if (cachedData) {
      try {
        renderPage(JSON.parse(cachedData));
      } catch (e) {
        console.error("Failed to parse cached data:", e);
      }
    }

    // 2. Fetch fresh data from Firebase in the background
    try {
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const snap = await get(child(ref(db), "/"));
      const freshData = snap.exists() ? snap.val() : {};

      // 3. Update page and cache if data is new
      if (JSON.stringify(freshData) !== cachedData) {
        renderPage(freshData);
        localStorage.setItem('userData', JSON.stringify(freshData));
      }
    } catch (err) {
      console.error(err);
      if (!cachedData) { // Only show error if there's no cache to display
        document.getElementById("name").textContent = "Error loading data";
        document.getElementById("links").innerHTML = ""; // Clear skeletons on error
      }
    }
  }

  main();
</script>
</body>
</html>
